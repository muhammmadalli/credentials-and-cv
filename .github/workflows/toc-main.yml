name: Generate Clickable TOC

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  toc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate TOC
        run: |
          README="README.md"
          TOC_TMP="repo_structure.md"

          # Generate Markdown TOC with links and emojis
          generate_structure() {
            echo "## üìÅ Repository Structure" > "$TOC_TMP"
            echo "" >> "$TOC_TMP"

            # Loop through all directories except .github and hidden ones
            find . -type d ! -path './.github*' ! -path './.*' | sort | while read -r dir; do
              [ "$dir" = "." ] && continue
              dir_name=$(basename "$dir")

              echo "<details>" >> "$TOC_TMP"
              echo "<summary>üìÅ <strong>$dir_name</strong></summary>" >> "$TOC_TMP"
              echo "" >> "$TOC_TMP"

              # List files in the directory with type-based emojis
              find "$dir" -maxdepth 1 -type f ! -name ".*" | sort | while IFS= read -r file; do
                file_name=$(basename "$file")
                file_path=$(echo "$file" | sed 's|^\./||;s/ /%20/g')

                # Convert filename to lowercase for safer matching
                file_lower=$(echo "$file_name" | tr '[:upper:]' '[:lower:]')

                # Emoji based on file extension
                case "$file_lower" in
                  *.md) emoji="üìÑ" ;;
                  *.pdf) emoji="üìÑ" ;;
                  *.doc|*.docx) emoji="üìù" ;;
                  *.py) emoji="üêç" ;;
                  *.js) emoji="‚ú®" ;;
                  *.json) emoji="üóÇÔ∏è" ;;
                  *.yml|*.yaml) emoji="üîß" ;;
                  *.sh) emoji="üñ•Ô∏è" ;;
                  *.txt) emoji="üìù" ;;
                  *.html) emoji="üåê" ;;
                  *.css) emoji="üé®" ;;
                  *.java) emoji="‚òï" ;;
                  *.c|*.cpp|*.h) emoji="üíª" ;;
                  *.png|*.jpg|*.jpeg|*.gif|*.svg) emoji="üñºÔ∏è" ;;
                  *.zip|*.tar|*.gz|*.rar) emoji="üì¶" ;;
                  *) emoji="üìÑ" ;;
                esac

                echo "- $emoji [$file_name]($file_path)" >> "$TOC_TMP"
              done
              
              echo "" >> "$TOC_TMP"
              echo "</details>" >> "$TOC_TMP"
              echo "" >> "$TOC_TMP"
            done
          }

          # Insert TOC into README.md between <!-- toc --> and <!-- tocstop -->
          insert_toc() {
            awk -v toc_file="$TOC_TMP" '
              function insert_toc() {
                while ((getline line < toc_file) > 0) print line
                close(toc_file)
              }

              BEGIN { in_toc=0 }

              /<!-- toc -->/ {
                print
                insert_toc()
                in_toc=1
                next
              }

              /<!-- tocstop -->/ {
                in_toc=0
                print
                next
              }

              in_toc == 0 {
                print
              }
            ' "$README" > "${README}.new"

            mv "${README}.new" "$README"
            rm "$TOC_TMP"
          }

          generate_structure
          insert_toc

      - name: Commit & push changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: update clickable TOC with emojis"
            git push origin HEAD:${GITHUB_REF##*/}
          else
            echo "No TOC updates needed"
          fi
